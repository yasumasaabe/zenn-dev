---
title: "Next.jsã¨web3authã‚’ä½¿ã£ã¦DAppã‚’ä½œã‚‹"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['nextjs', 'web3', 'solidity', 'typescript']
published: true
---

# æœ¬è¨˜äº‹ã®å¯¾è±¡è€…
* web3authã‚’ä½¿ã£ã¦èªè¨¼ã‚’å°å…¥ã—ãŸã„
* Next.jsã«Web3æŠ€è¡“ã‚’å°å…¥ã—ãŸã„

# æœ¬è¨˜äº‹ã®ãƒªãƒã‚¸ãƒˆãƒª
https://github.com/yasumasaabe/web3-study-session-next
ãœã²å‚è€ƒã«ã—ã¦ãã ã•ã„ï¼

# web3authã¨ã¯
å…¨ã¦ã®ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã€WebãŠã‚ˆã³ãƒ¢ãƒã‚¤ãƒ«ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã€ãŠã‚ˆã³ãã®ã»ã‹ã®ã‚­ãƒ¼ç®¡ç†æ–¹æ³•ã‚’å…¨ã¦é›†ç´„ã—ã¦ãã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã€‚
é–‹ç™ºè€…ãŒæ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã€Googleã‚„Twitterã®ã‚ˆã†ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ä¼¼ãŸã€ã‚ˆã‚Šä¸€èˆ¬çš„ãªãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã‚’æä¾›ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ã¾ãŸã€é–‹ç™ºè€…ã¯ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã‚·ãƒ¼ãƒ‰ãƒ•ãƒ¬ãƒ¼ã‚ºèªè¨¼ã®æä¾›ã‚’ç¶™ç¶šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

# Dappsã¨ã¯
Dappsã¯Decentralized Applicationsã®ç•¥ç§°ã§ã™ã€‚
ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã§ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’å‹•ä½œã•ã›ã‚‹ä»•çµ„ã¿ã€Œã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã€ã‚’å¿œç”¨ã—ãŸã‚‚ã®ã€‚

DappsãŒãƒ‘ã‚½ã‚³ãƒ³ã‚„ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã¨ã„ã£ãŸé€šå¸¸ã®ã‚¢ãƒ—ãƒªã¨ç•°ãªã‚‹ç‚¹ã¯ã€
- è€ä¹…æ€§ï¼šã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã«å±¥æ­´ã‚„ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã—ã¤ã¤ã€åˆ†æ•£ç®¡ç†ã«ã‚ˆã£ã¦å¸¸ã«ç¨¼åƒã—ç¶šã‘ã‚‰ã‚Œã‚‹ã€‚
- é€æ˜æ€§ï¼šèª°ã‚‚ãŒã‚³ãƒ¼ãƒ‰ã‚’æ¤œæŸ»å¯èƒ½ã§ã€æ“ä½œãƒ­ã‚°ãŒãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã«æ°¸é ã«ä¿å­˜ã•ã‚Œã‚‹ã€‚
- æ¤œé–²è€æ€§ï¼šä¸­å¤®é›†æ¨©çš„ãªç®¡ç†è€…ãªã—ã§Dappsã¨é€šä¿¡å¯èƒ½ã€‚ä¸€åº¦ãƒ‡ãƒ—ãƒ­ã‚¤(æœ¬ç•ªç’°å¢ƒã«è¨­ç½®)ã•ã‚Œã‚‹ã¨ã€ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã§ããªã„ã€‚
ã‚¢ãƒ—ãƒªã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæ„å½¢æˆãŒå¿…è¦ã€‚

# Next.jsã®ç’°å¢ƒæ§‹ç¯‰
1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
```sh
## Next.jsã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
$ npx create-next-app . -e with-tailwindcss
```

2. çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›´
```diff tsconfig.json
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
-    "incremental": true
+    "incremental": true,
+    "baseUrl": "."
  },
```

## web3authã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®æº–å‚™
web3authã«ãŠã‘ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDãŒå¿…è¦ã«ãªã‚‹ãŸã‚
Dashboardã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’å–å¾—ã™ã‚‹

https://dashboard.web3auth.io/
1. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ»ãƒ­ã‚°ã‚¤ãƒ³
â€»ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ãªãã¦ã‚‚ã€
æœ¬è¨˜äº‹ã§ã¯Googleã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ
![](https://i.gyazo.com/17ef41efcf029b884c9b07a105f5f3ae.png)

1000 Monthly Active Usersã§ã‚ã‚Œã°Freeã§ä½¿ãˆã‚‹ã‚ˆã†ã§ã™

2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
Web3authã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€é–‹ç™ºè€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
![](https://i.gyazo.com/7d116653bbb24ed206935d69eefccbc3.png)

## web3authã®å°å…¥
ä¸‹è¨˜å…¬å¼ã‚µã‚¤ãƒˆã‚’å‚è€ƒã«ã—ã¦å°å…¥ã—ã¾ã™
https://web3auth.io/docs/integration-builder?lang=next&chain=eth&customAuthentication=no&whitelabel=no&customLogin=no

1. package.jsonã«ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```diff json:package.json
  "dependencies": {
+    "@web3auth/base": "^1.1.0",
+    "@web3auth/web3auth": "^1.1.0",
+    "@web3auth/ethereum-provider": "^1.0.0",
+    "web3": "^1.7.0",
    "next": "latest",
    "react": "18.1.0",
    "react-dom": "18.1.0"
  },
  "devDependencies": {
+    "@types/elliptic": "^6.4.14",
    "@types/node": "17.0.35",
    "@types/react": "18.0.9",
    "@types/react-dom": "18.0.5",
    "autoprefixer": "^10.4.7",
    "postcss": "^8.4.14",
    "tailwindcss": "^3.1.2",
    "typescript": "4.7.2"
  }
```
```sh
$ npm i
```

2. App.tsxã‚’ä½œæˆã—ã¦ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹
```sh
$ touch pages/App.tsx
```
```tsx:pages/App.tsx
import { useEffect, useState } from "react";
import { Web3Auth } from "@web3auth/web3auth";
import { CHAIN_NAMESPACES, SafeEventEmitterProvider } from "@web3auth/base";
import RPC from "./evm";

const clientId = "#######################"; // get from https://dashboard.web3auth.io Torus walletã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID

function App() {
  const [web3auth, setWeb3auth] = useState<Web3Auth | null>(null);
  const [provider, setProvider] = useState<SafeEventEmitterProvider | null>(null);

  useEffect(() => {
    const init = async () => {
      try {
      const web3auth = new Web3Auth({
        clientId,
        chainConfig: {
          chainNamespace: "eip155", // polygon-mumbaiç”¨
          chainId:  "0x13881", // polygon-mumbaiç”¨
          rpcTarget: "####################", // ç§ã¯infuraçµŒç”±ã§polygon-mumbaiã«ã‚¢ãƒƒãƒ—ã—ã¦ãŠã‚Šã¾ã™ãŒã€ãƒ†ã‚¹ãƒˆç’°å¢ƒã¯ãŠä»»ã›ã—ã¾ã™ã€‚
        },
      });

          setWeb3auth(web3auth);

      await web3auth.initModal();
      if (web3auth.provider) {
        setProvider(web3auth.provider);
      }
        } catch (error) {
          console.error(error);
        }
      };

      init();
  }, []);

  const login = async () => {
    if (!web3auth) {
      console.log("web3auth not initialized yet");
      return;
    }
    const web3authProvider = await web3auth.connect();
    setProvider(web3authProvider);
  };

  const getUserInfo = async () => {
    if (!web3auth) {
      console.log("web3auth not initialized yet");
      return;
    }
    const user = await web3auth.getUserInfo();
    console.log(user);
  };

  const logout = async () => {
    if (!web3auth) {
      console.log("web3auth not initialized yet");
      return;
    }
    await web3auth.logout();
    setProvider(null);
  };

  const getChainId = async () => {
    if (!provider) {
      console.log("provider not initialized yet");
      return;
    }
    const rpc = new RPC(provider);
    const chainId = await rpc.getChainId();
    console.log(chainId);
  };
  const getAccounts = async () => {
    if (!provider) {
      console.log("provider not initialized yet");
      return;
    }
    const rpc = new RPC(provider);
    const address = await rpc.getAccounts();
    console.log(address);
  };

  const getBalance = async () => {
    if (!provider) {
      console.log("provider not initialized yet");
      return;
    }
    const rpc = new RPC(provider);
    const balance = await rpc.getBalance();
    console.log(balance);
  };

  const signMessage = async () => {
    if (!provider) {
      console.log("provider not initialized yet");
      return;
    }
    const rpc = new RPC(provider);
    const signedMessage = await rpc.signMessage();
    console.log(signedMessage);
  };

  const getPrivateKey = async () => {
    if (!provider) {
      console.log("provider not initialized yet");
      return;
    }
    const rpc = new RPC(provider);
    const privateKey = await rpc.getPrivateKey();
    console.log(privateKey);
  };
  const loggedInView = (
    <>
      <button onClick={getUserInfo} className="card">
        Get User Info
      </button>
      <button onClick={getChainId} className="card">
        Get Chain ID
      </button>
      <button onClick={getAccounts} className="card">
        Get Accounts
      </button>
      <button onClick={getBalance} className="card">
        Get Balance
      </button>
      <button onClick={signMessage} className="card">
        Sign Message
      </button>
      <button onClick={getPrivateKey} className="card">
        Get Private Key
      </button>
      <button onClick={logout} className="card">
        Log Out
      </button>

      <div id="console" style={{ whiteSpace: "pre-line" }}>
        <p style={{ whiteSpace: "pre-line" }}></p>
      </div>
    </>
  );

  const unloggedInView = (
    <button onClick={login} className="card">
      Login
    </button>
  );

  return (
    <div className="container">
      <h1 className="title">
        <a target="_blank" href="http://web3auth.io/" rel="noreferrer">
          Web3Auth
        </a>
        & ReactJS Example
      </h1>

      <div className="grid">{provider ? loggedInView : unloggedInView}</div>

      <footer className="footer">
        <a href="https://github.com/Web3Auth/Web3Auth/tree/master/examples/react-app" target="_blank" rel="noopener noreferrer">
          Source code
        </a>
      </footer>
    </div>
  );
}

export default App;
```
â€»å„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ChainIdãªã©ã®æƒ…å ±ã¾ã¨ã‚
https://zenn.dev/watson_sei/articles/0bf87f4bb70207

3. App.tsxã®clientIdã®YOUR_CLIENT_IDã«è‡ªåˆ†ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’å…¥åŠ›ã™ã‚‹
1. ä¸‹è¨˜ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
https://dashboard.web3auth.io



4. evm.tsã‚’ä½œæˆã—ã¦ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹
```sh
$ touch pages/evm.ts
```
```ts:pages/evm.ts
import type { SafeEventEmitterProvider } from "@web3auth/base";
import Web3 from "web3";

export default class EthereumRpc {
  private provider: SafeEventEmitterProvider;

  constructor(provider: SafeEventEmitterProvider) {
    this.provider = provider;
  }

  async getChainId(): Promise<string> {
    try {
      const web3 = new Web3(this.provider as any);

      // Get the connected Chain's ID
      const chainId = await web3.eth.getChainId();

      return chainId.toString();
    } catch (error) {
      return error as string;
    }
  }

  async getAccounts(): Promise<any> {
    try {
      const web3 = new Web3(this.provider as any);

      // Get user's Ethereum public address
      const address = (await web3.eth.getAccounts())[0];

      return address;
    } catch (error) {
      return error;
    }
  }

  async getBalance(): Promise<string> {
    try {
      const web3 = new Web3(this.provider as any);

      // Get user's Ethereum public address
      const address = (await web3.eth.getAccounts())[0];

      // Get user's balance in ether
      const balance = web3.utils.fromWei(
        await web3.eth.getBalance(address) // Balance is in wei
      );

      return balance;
    } catch (error) {
      return error as string;
    }
  }

  async signMessage() {
    try {
      const web3 = new Web3(this.provider as any);

      // Get user's Ethereum public address
      const fromAddress = (await web3.eth.getAccounts())[0];

      const originalMessage = "YOUR_MESSAGE";

      // Sign the message
      const signedMessage = await web3.eth.personal.sign(
        originalMessage,
        fromAddress,
        "test password!" // configure your own password here.
      );

      return signedMessage;
    } catch (error) {
      return error as string;
    }
  }

  async getPrivateKey(): Promise<any> {
    try {
      const privateKey = await this.provider.request({
        method: "eth_private_key",
      });

      return privateKey;
    } catch (error) {
      return error as string;
    }
  }
}
```
5. index.tsxã‚’ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã®ã‚ˆã†ã«ä¿®æ­£
``` ts:index.tsx
import type { NextPage } from 'next';
import dynamic from "next/dynamic";

const App = dynamic(
  () => {
    return import("./App");
  },
  { ssr: false }
);

const Home: NextPage = () => {
  return <App />;
}

export default Home
```

6. global.cssã‚’ä¸‹è¨˜ã«ä¿®æ­£ã™ã‚‹
``` css:global.css
html,
body {
  padding: 0;
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen,
    Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif;
}

a {
  color: inherit;
  text-decoration: none;
}

* {
  box-sizing: border-box;
}

.container {
  width: 60%;
  margin: auto;
  padding: 0 2rem;
}

.main {
  min-height: 100vh;
  padding: 4rem 0;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.title {
  line-height: 1.15;
  font-size: 3rem;
  text-align: center;
  margin: 50px;
}

.title a {
  color: #0070f3;
  text-decoration: none;
}

.grid {
  display: flex;
  align-items: center;
  flex-direction: column;
}

.card {
  margin: 0.5rem;
  padding: 0.7rem;
  text-align: center;
  color: #0070f3;
  background-color: #fafafa;
  text-decoration: none;
  border: 1px solid #0070f3;
  border-radius: 10px;
  transition: color 0.15s ease, border-color 0.15s ease;
  width: 100%;
}

.card:hover,
.card:focus,
.card:active {
  cursor: pointer;
  background-color: #f1f1f1;
}

.footer {
  display: flex;
  flex: 1;
  padding: 2rem 0;
  border-top: 1px solid #eaeaea;
  justify-content: center;
  align-items: center;
  margin-top: 10rem;
}

.footer a {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-grow: 1;
}

.logo {
  height: 1.5rem;
  margin-left: 0.5rem;
}

@media (max-width: 1200px) {
  .container {
    width: 100%;
  }
}
```

# Walletã‚’ä½œæˆ
1. index.tsxã‚’ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã®ã‚ˆã†ã«ä¿®æ­£
â€» polygonãƒã‚§ãƒ¼ãƒ³ã‚’ä½¿ã£ã¦ãŠã‚Šã¾ã™ã€‚
```diff ts:index.tsx
      web3auth = new window.Web3auth.Web3Auth({
        clientId,
        chainConfig: {
          chainNamespace: "eip155",
-         chainId: "0x1",
-         rpcTarget: "https://rpc.ankr.com/eth"
+         chainId: "0x13881",
+         rpcTarget: "https://polygon-mumbai.infura.io/v3/81984a3dbd7d4446886a8add0f51aa79"
        },
      });
```

2. ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã«etherã‚’å–å¾—ã™ã‚‹
polygon Faucetã§ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã«etherã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
https://faucet.polygon.technology/

Wallet Addressã¯Get Accountsã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹çµæœã‚’è¨˜è¼‰ã™ã‚‹ã€‚
1~2åˆ†å¾Œã«æŒ‡å®šã—ãŸWalletã«etherãŒä»˜ä¸ã•ã‚Œã¦ã„ã¾ã™ã€‚

ç¶šãã¯åˆ¥ã®è¨˜äº‹ã§è¨˜è¼‰ã—ã¾ã™ã€‚
ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ä½œæˆã—ãŸNFTã‚’è‡ªèº«ã®walletã«mintã™ã‚‹ã¨ã“ã‚ã‚ˆã‚Šã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚

# å‚è€ƒ
web3auth Documentation
https://web3auth.io/docs/

å„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ChainIdã‚„RPCUrlãªã©ã®æƒ…å ±ã¾ã¨ã‚
https://zenn.dev/watson_sei/articles/0bf87f4bb70207